<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>BeanPing</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            animation: {
              "fade-in": "fadeIn 0.5s ease-in-out",
            },
            keyframes: {
              fadeIn: {
                "0%": { opacity: "0" },
                "100%": { opacity: "1" },
              },
            },
            colors: {
              slate: {
                850: "#1e293b", 
              }
            }
          },
        },
      };
    </script>
    <style>
      .glass-morphism {
        background: rgba(30, 41, 59, 0.95);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .mesh-bg {
        background: linear-gradient(
          135deg,
          #1e293b 0%,
          #0f172a 50%,
          #1e1b4b 100%
        );
      }
      .btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 10px 16px;
        border-radius: 8px;
        font-weight: 500;
        font-size: 14px;
        transition: all 0.2s;
        cursor: pointer;
        border: none;
        color: #e2e8f0;
      }
      .btn-sm {
        padding: 6px 12px;
        font-size: 12px;
        gap: 4px;
      }
      .menu-btn {
        cursor: pointer;
        padding: 6px;
        border-radius: 9999px;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 30px;
        height: 30px;
      }
      .menu-btn:hover {
        background: rgba(255, 255, 255, 0.1);
      }
      .active-view {
        background-color: rgba(96, 165, 250, 0.2) !important;
        color: #93c5fd !important;
      }
      .dropdown {
        display: none;
        position: absolute;
        right: 0;
        top: calc(100% + 8px);
        z-index: 50;
      }
      .node-card {
        position: relative;
      }
      .list-row {
        display: grid;
        grid-template-columns: 1.5fr 1fr 1fr 1fr 1fr auto;
        align-items: center;
        gap: 1rem;
        padding: 1rem 1.5rem;
      }
      .list-header-btn {
        display: flex;
        align-items: center;
        gap: 4px;
        background: none;
        border: none;
        color: #cbd5e1;
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 4px;
        transition: all 0.2s;
        font-weight: 500;
      }
      .list-header-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        color: #f1f5f9;
      }
      .list-header-btn.active {
        color: #60a5fa;
      }
      .sort-icon {
        width: 12px;
        height: 12px;
        margin-left: 4px;
        opacity: 0.7;
        transition: transform 0.2s;
      }
      .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
      }
      .status-dot.online {
        background: #22c55e;
        box-shadow: 0 0 5px #22c55e;
      }
      .status-dot.offline {
        background: #ef4444;
      }
      .node-link {
        color: #dbeafe;
        text-decoration: none;
        transition: color 0.2s;
      }
      .node-link:hover {
        color: #60a5fa;
        text-decoration: underline;
      }
      /* Tab Styles */
      .tab-btn {
        padding: 0.5rem 1rem;
        border-bottom: 2px solid transparent;
        color: #94a3b8;
        transition: all 0.2s;
      }
      .tab-btn.active {
        border-bottom-color: #60a5fa;
        color: #60a5fa;
      }
      .toggle-checkbox:checked {
        right: 0;
        border-color: #68D391;
      }
      .toggle-checkbox:checked + .toggle-label {
        background-color: #68D391;
      }
    </style>
  </head>
  <body
    class="min-h-screen mesh-bg text-slate-200 overflow-x-hidden p-4 md:p-8 flex flex-col"
  >
    <!-- Background elements -->
    <div class="fixed inset-0 overflow-hidden pointer-events-none -z-10">
      <div
        class="absolute -top-40 -right-40 w-96 h-96 bg-purple-600 rounded-full mix-blend-screen filter blur-3xl opacity-20"
      ></div>
      <div
        class="absolute -bottom-40 -left-40 w-96 h-96 bg-blue-600 rounded-full mix-blend-screen filter blur-3xl opacity-20"
      ></div>
    </div>

    <div class="max-w-7xl mx-auto space-y-6 animate-fade-in flex-grow w-full">
      <!-- UPDATE BANNER (Hidden by default) -->
      <div id="updateBanner" class="hidden glass-morphism bg-emerald-500/10 border-emerald-500/30 p-4 rounded-xl items-center justify-between shadow-xl mb-4">
        <div class="flex items-center gap-3">
          <div class="p-2 bg-emerald-500/20 rounded-full text-emerald-400">
            <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 11l5-5m0 0l5 5m-5-5v12" /></svg>
          </div>
          <div>
            <h3 class="font-bold text-emerald-100">Update Available!</h3>
            <p class="text-sm text-emerald-200/80">A new version (<span id="newVersionNumber"></span>) is available on GitHub.</p>
          </div>
        </div>
        <div class="flex items-center gap-3">
          <a href="https://github.com/beanman109/beanping" target="_blank" class="btn btn-sm bg-emerald-600 hover:bg-emerald-500 text-white shadow-lg shadow-emerald-500/20">View on GitHub</a>
          <button onclick="dismissUpdate()" class="text-slate-400 hover:text-white transition">&times;</button>
        </div>
      </div>

      <!-- Header -->
      <header class="text-center">
        <h1
          class="text-5xl font-bold bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent"
        >
          BeanPing
        </h1>
        <p class="text-slate-400 mt-2">Remote latency monitoring solution</p>
      </header>

      <!-- Problem Nodes Section -->
      <div
        id="problemNodesSection"
        class="glass-morphism rounded-2xl p-6 shadow-2xl"
      >
        <h2
          class="text-xl font-semibold text-red-400 mb-4 flex items-center gap-2"
        >
          <svg class="w-5 h-5" fill="currentColor">
            <use href="icons.svg#icon-warning"></use>
          </svg>
          Problem Nodes
        </h2>
        <ul id="problemNodesList" class="space-y-2">
          <% if (problemNodes.length === 0) { %>
          <li class="text-green-400 flex items-center gap-2 text-sm">
            <svg class="w-5 h-5" fill="currentColor">
              <use href="icons.svg#icon-check-circle"></use>
            </svg>
            No problem nodes detected in the last hour.
          </li>
          <% } else { %> <% problemNodes.forEach(p => { %>
          <li
            class="flex flex-wrap justify-between items-center bg-slate-900/50 p-3 rounded-lg text-sm"
          >
            <div>
              <a href="/node/<%= p.id %>" class="font-semibold node-link"
                ><%= p.name %></a
              >
              <span class="text-slate-400 ml-2">(<%= p.ip %>)</span>
            </div>
            <div class="text-slate-300 text-right">
              <% if (p.loss10Count >= 4) { %>
              <span class="text-orange-400"
                >Packet Loss (10% - <%= p.loss10Count %> times)</span
              >
              <% } %> <% if (p.highLossCount >= 4) { %>
              <span class="text-red-400 ml-2"
                >High Packet Loss (>10% - <%= p.highLossCount %> times)</span
              >
              <% } %> <% if (p.highJitterCount >= 4) { %>
              <span class="ml-2 text-yellow-400"
                >High Jitter (<%= p.highJitterCount %> times)</span
              >
              <% } %>
            </div>
          </li>
          <% }) %> <% } %>
        </ul>
      </div>

      <!-- Add Node + Global Tools -->
      <div class="glass-morphism rounded-2xl p-6 shadow-2xl">
        <div class="flex justify-center gap-3 flex-wrap">
          <button
            id="toggleAddNode"
            class="btn glass-morphism hover:bg-white/10"
          >
            <svg class="w-5 h-5" fill="currentColor">
              <use href="icons.svg#icon-plus"></use>
            </svg>
            Add Node
          </button>
          <button
            id="globalMtrBtn"
            class="btn glass-morphism hover:bg-white/10"
          >
            <svg class="w-5 h-5" fill="currentColor">
              <use href="icons.svg#icon-mtr"></use>
            </svg>
            Run MTR
          </button>
          <button
            id="globalTraceBtn"
            class="btn glass-morphism hover:bg-white/10"
          >
            <svg class="w-5 h-5" fill="currentColor">
              <use href="icons.svg#icon-traceroute"></use>
            </svg>
            Run Traceroute
          </button>
          <button
            onclick="window.location.href='/compare'"
            class="btn glass-morphism hover:bg-white/10"
          >
            <svg class="w-5 h-5" fill="currentColor">
              <use href="icons.svg#icon-compare"></use>
            </svg>
            Compare
          </button>
        </div>
        <form
          id="addNodeForm"
          class="grid grid-cols-1 md:grid-cols-[1fr,1fr,auto] gap-4 mt-6 hidden"
        >
          <input
            type="text"
            id="name"
            placeholder="Node Name"
            required
            class="w-full p-2 rounded-lg bg-slate-900/50 border border-slate-600 focus:ring-2 focus:ring-blue-500 focus:outline-none transition"
          />
          <input
            type="text"
            id="ip"
            placeholder="IP Address"
            required
            class="w-full p-2 rounded-lg bg-slate-900/50 border border-slate-600 focus:ring-2 focus:ring-blue-500 focus:outline-none transition"
          />
          <button
            type="submit"
            class="btn glass-morphism hover:bg-blue-500/30"
          >
            Add
          </button>
        </form>
      </div>

      <!-- Search Bar -->
      <div class="relative max-w-2xl mx-auto">
        <svg
          class="w-5 h-5 text-slate-400 absolute left-4 top-1/2 -translate-y-1/2 pointer-events-none"
          fill="currentColor"
        >
          <use href="icons.svg#icon-search"></use>
        </svg>
        <input
          type="text"
          id="nodeSearch"
          placeholder="Search nodes by name or IP..."
          autocomplete="off"
          class="w-full pl-11 pr-4 py-3 glass-morphism rounded-xl focus:ring-2 focus:ring-blue-500 focus:outline-none transition"
        />
        <div
          id="nodeDropdown"
          class="hidden absolute top-full left-0 right-0 mt-2 glass-morphism rounded-xl shadow-2xl max-h-60 overflow-y-auto z-50"
        ></div>
      </div>

      <!-- Monitored Nodes Header -->
      <div class="flex justify-between items-center mt-6">
        <h2
          class="text-2xl font-semibold bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent"
        >
          Monitored Nodes
        </h2>
        <div class="controls-container flex gap-2">
          <button
            id="gridBtn"
            class="btn btn-sm glass-morphism hover:bg-white/10"
          >
            <svg class="w-4 h-4" fill="currentColor">
              <use href="icons.svg#icon-grid"></use>
            </svg>
          </button>
          <button
            id="listBtn"
            class="btn btn-sm glass-morphism hover:bg-white/10"
          >
            <svg class="w-4 h-4" fill="currentColor">
              <use href="icons.svg#icon-list"></use>
            </svg>
          </button>
          <div class="relative">
            <button
              id="mainMenuBtn"
              class="btn btn-sm glass-morphism hover:bg-white/10"
            >
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path
                  d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"
                />
              </svg>
            </button>
            <div
              id="mainDropdown"
              class="dropdown glass-morphism rounded-xl shadow-2xl w-48 overflow-hidden"
            >
              <button
                id="openSettingsBtn"
                class="flex items-center gap-3 w-full text-left px-4 py-3 hover:bg-white/10"
              >
                Settings & Webhooks
              </button>
              <button
                id="backupBtn"
                class="flex items-center gap-3 w-full text-left px-4 py-3 hover:bg-white/10"
              >
                Backup Database
              </button>
              <button
                id="restoreBtn"
                class="flex items-center gap-3 w-full text-left px-4 py-3 hover:bg-white/10"
              >
                Restore Database
              </button>
              <button
                id="vtraceBtn"
                class="flex items-center gap-3 w-full text-left px-4 py-3 hover:bg-white/10"
              >
                Visual Traceroute
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- List Header -->
      <div id="listHeader" class="hidden glass-morphism rounded-xl px-6 py-3">
        <div
          class="grid grid-cols-[1.5fr,1fr,1fr,1fr,1fr,auto] items-center gap-4 text-sm text-slate-400"
        >
          <button class="list-header-btn" data-sort="name">
            Name <svg class="sort-icon" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" /></svg>
          </button>
          <button class="list-header-btn" data-sort="ip">
            IP Address <svg class="sort-icon" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" /></svg>
          </button>
          <button class="list-header-btn" data-sort="latency">
            Latency <svg class="sort-icon" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" /></svg>
          </button>
          <button class="list-header-btn" data-sort="loss">
            Packet Loss <svg class="sort-icon" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" /></svg>
          </button>
          <button class="list-header-btn" data-sort="jitter">
            Jitter <svg class="sort-icon" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" /></svg>
          </button>
          <div class="text-center font-medium">Actions</div>
        </div>
      </div>

      <!-- Nodes Container -->
      <div id="nodesContainer" class="gap-6">
        <% stats.sort((a,b) => a.name.localeCompare(b.name)).forEach(s => { 
           // Pre-calculate display values to avoid clutter in HTML
           // s.packet_loss and s.avgJitter now come pre-calculated from the backend
           const loss = (s.packet_loss || 0).toFixed(1);
           const jitter = (s.avgJitter || 0).toFixed(2);
           const latency = s.latency !== null ? s.latency : 'N/A';
        %>
        <div
          class="node-card"
          id="node-<%= s.id %>"
          data-name="<%= s.name.toLowerCase() %>"
          data-ip="<%= s.ip %>"
        >
          <!-- Grid view card -->
          <div class="grid-view glass-morphism rounded-2xl p-6 shadow-2xl">
            <div class="flex items-start justify-between mb-3">
              <div class="flex items-center gap-3">
                <span class="status-dot <%= s.status %>"></span>
                <div>
                  <a
                    href="/node/<%= s.id %>"
                    class="text-lg font-semibold node-link node-name"
                    ><%= s.name %></a
                  >
                  <p class="text-sm text-slate-400 node-ip"><%= s.ip %></p>
                </div>
              </div>
              <div class="relative">
                <button
                  class="menu-btn"
                  onclick="toggleMenu('grid', <%= s.id %>)"
                >
                  <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"/></svg>
                </button>
                <div id="menu-grid-<%= s.id %>" class="dropdown glass-morphism rounded-xl shadow-2xl w-36 overflow-hidden">
                  <button onclick="editNode(<%= s.id %>, `<%- s.name %>`, `<%- s.ip %>`)" class="flex items-center gap-3 w-full text-left px-4 py-3 hover:bg-white/10">Edit</button>
                  <button onclick="deleteNode(<%= s.id %>)" class="flex items-center gap-3 w-full text-left px-4 py-3 hover:bg-white/10">Remove</button>
                </div>
              </div>
            </div>
            <div class="space-y-1 text-sm text-slate-300">
              <p><strong>Latency:</strong> <span class="latency"><%= latency %></span> ms</p>
              <p><strong>Packet Loss (1h):</strong> <span class="loss"><%= loss %></span>%</p>
              <p><strong>Jitter (1h):</strong> <span class="jitter"><%= jitter %></span> ms</p>
            </div>
            <div class="mt-4">
              <a href="/node/<%= s.id %>" class="btn btn-sm glass-morphism hover:bg-white/10">
                View Details
              </a>
            </div>
          </div>

          <!-- List view row -->
          <div class="list-view hidden glass-morphism rounded-xl">
            <div class="list-row">
                <div class="flex items-center gap-3">
                <span class="status-dot <%= s.status %>"></span>
                <div>
                    <a href="/node/<%= s.id %>" class="font-semibold node-link node-name"><%= s.name %></a>
                </div>
                </div>
                <div class="text-sm text-slate-400 node-ip"><%= s.ip %></div>
                <div class="text-sm"><span class="latency"><%= latency %></span> ms</div>
                <div class="text-sm"><span class="loss"><%= loss %></span>%</div>
                <div class="text-sm"><span class="jitter"><%= jitter %></span> ms</div>
                <div class="flex items-center justify-center gap-2">
                <a href="/node/<%= s.id %>" class="menu-btn hover:bg-white/10">
                    <svg class="w-5 h-5" fill="currentColor"><use href="icons.svg#icon-chart"></use></svg>
                </a>
                <div class="relative">
                    <button class="menu-btn" onclick="toggleMenu('list', <%= s.id %>)">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"/></svg>
                    </button>
                    <div id="menu-list-<%= s.id %>" class="dropdown glass-morphism rounded-xl shadow-2xl w-36 overflow-hidden">
                    <button onclick="editNode(<%= s.id %>, `<%- s.name %>`, `<%- s.ip %>`)" class="flex items-center gap-3 w-full text-left px-4 py-3 hover:bg-white/10">Edit</button>
                    <button onclick="deleteNode(<%= s.id %>)" class="flex items-center gap-3 w-full text-left px-4 py-3 hover:bg-white/10">Remove</button>
                    </div>
                </div>
                </div>
            </div>
          </div>
        </div>
        <% }) %>
      </div>

      <!-- Footer with Version -->
      <footer class="mt-8 text-center text-slate-500 text-sm pb-4">
        v1.1.2
      </footer>

    </div>

    <!-- Modals -->
    <div id="globalTestModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden items-center justify-center z-50 p-4"></div>
    <div id="editModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden items-center justify-center z-50 p-4"></div>
    
    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden items-center justify-center z-50 p-4">
      <div class="glass-morphism rounded-2xl shadow-2xl w-full max-w-2xl max-h-[85vh] flex flex-col animate-fade-in">
        <header class="p-4 border-b border-white/10 flex justify-between items-center">
          <h2 class="text-xl font-semibold bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">Global Settings</h2>
          <button onclick="closeSettingsModal()" class="w-8 h-8 rounded-full hover:bg-white/10 flex items-center justify-center transition">&times;</button>
        </header>
        <div class="flex border-b border-white/10 px-4">
          <button class="tab-btn active" onclick="switchSettingsTab('general')">General</button>
          <button class="tab-btn" onclick="switchSettingsTab('webhooks')">Webhooks</button>
        </div>
        <div class="p-6 overflow-y-auto flex-grow">
          <!-- General Settings Tab -->
          <div id="settings-tab-general" class="space-y-6">
            <h3 class="text-lg font-medium text-blue-300">Grace Periods</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-slate-300 mb-2 text-sm">Offline Grace Period (pings)</label>
                <input type="number" id="setting_offline" class="w-full p-2 rounded-lg bg-slate-900/50 border border-slate-600 focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
                <p class="text-xs text-slate-500 mt-1">Consecutive failed pings before marking offline.</p>
              </div>
              <div>
                <label class="block text-slate-300 mb-2 text-sm">Online Grace Period (pings)</label>
                <input type="number" id="setting_online" class="w-full p-2 rounded-lg bg-slate-900/50 border border-slate-600 focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
                <p class="text-xs text-slate-500 mt-1">Consecutive success pings before marking online.</p>
              </div>
            </div>
            
            <h3 class="text-lg font-medium text-blue-300 pt-4 border-t border-white/10">Thresholds</h3>
            <div>
              <label class="block text-slate-300 mb-2 text-sm">Packet Loss Threshold (%)</label>
              <input type="number" id="setting_loss" class="w-full p-2 rounded-lg bg-slate-900/50 border border-slate-600 focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
              <p class="text-xs text-slate-500 mt-1">Packet loss percentage to consider a ping as "failed".</p>
            </div>
            
            <div class="pt-4 flex justify-end">
              <button onclick="saveGlobalSettings()" class="btn glass-morphism hover:bg-blue-500/30">Save Settings</button>
            </div>
          </div>

          <!-- Webhooks Tab -->
          <div id="settings-tab-webhooks" class="hidden space-y-6">
            <div class="flex justify-between items-center">
              <h3 class="text-lg font-medium text-blue-300">Global Webhooks</h3>
              <button onclick="showAddWebhookForm()" class="btn btn-sm glass-morphism hover:bg-white/10">+ Add Webhook</button>
            </div>
            
            <div id="addWebhookForm" class="hidden bg-slate-800/50 p-4 rounded-lg border border-slate-700 space-y-3">
               <input type="text" id="newWebhookName" placeholder="Webhook Name (e.g. Discord)" class="w-full p-2 rounded bg-slate-900 border border-slate-600 text-sm">
               <input type="text" id="newWebhookUrl" placeholder="Webhook URL" class="w-full p-2 rounded bg-slate-900 border border-slate-600 text-sm">
               <div class="flex items-center gap-4 text-sm">
                 <label class="flex items-center gap-2"><input type="checkbox" id="newWebhookOnline" checked> Notify Online</label>
                 <label class="flex items-center gap-2"><input type="checkbox" id="newWebhookOffline" checked> Notify Offline</label>
               </div>
               <div class="flex gap-2 justify-end">
                 <button onclick="document.getElementById('addWebhookForm').classList.add('hidden')" class="text-xs text-slate-400 hover:text-white">Cancel</button>
                 <button onclick="addWebhook()" class="btn btn-sm glass-morphism hover:bg-green-500/30">Save</button>
               </div>
            </div>

            <div id="webhookList" class="space-y-3">
              <!-- Populated by JS -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <input type="file" id="restoreFileInput" accept=".db" class="hidden" />

    <script>
      const socket = io();
      let currentGlobalTest = null;
      let allNodes = [];
      let filteredNodes = [];
      let currentSort = { field: 'name', direction: 1 };
      let nodeStats = new Map();

      // CURRENT LOCAL VERSION
      const LOCAL_VERSION = '1.1.0';
      const REPO_FILE_URL = 'https://raw.githubusercontent.com/beanman109/beanping/refs/heads/main/views/dashboard.ejs';

      // --- Update Checker ---
      document.addEventListener('DOMContentLoaded', checkForUpdates);

      async function checkForUpdates() {
        // Check for 12-hour timeout in localStorage
        const dismissedTime = localStorage.getItem('beanping_update_dismissed');
        if (dismissedTime) {
          const hoursSince = (Date.now() - parseInt(dismissedTime, 10)) / (1000 * 60 * 60);
          if (hoursSince < 12) {
            return; // Exit if dismissed recently
          }
        }

        try {
          const response = await fetch(REPO_FILE_URL);
          if (!response.ok) return; 
          
          const text = await response.text();
          const versionMatch = text.match(/v(\d+\.\d+\.\d+)/g);
          
          if (versionMatch && versionMatch.length > 0) {
            const remoteVersionString = versionMatch[versionMatch.length - 1].replace('v', '');
            
            if (isNewerVersion(LOCAL_VERSION, remoteVersionString)) {
               document.getElementById('newVersionNumber').textContent = 'v' + remoteVersionString;
               document.getElementById('updateBanner').classList.remove('hidden');
               document.getElementById('updateBanner').classList.add('flex');
            }
          }
        } catch (e) {
          console.log('Update check failed:', e);
        }
      }

      function dismissUpdate() {
        document.getElementById('updateBanner').classList.add('hidden');
        localStorage.setItem('beanping_update_dismissed', Date.now().toString());
      }

      function isNewerVersion(local, remote) {
        const localParts = local.split('.').map(Number);
        const remoteParts = remote.split('.').map(Number);
        
        for (let i = 0; i < 3; i++) {
          if (remoteParts[i] > localParts[i]) return true;
          if (remoteParts[i] < localParts[i]) return false;
        }
        return false;
      }

      // --- Node Data ---
      // OPTIMIZATION: Data now comes fully pre-populated from backend. No fetches needed.
      <% const nodesJson = JSON.stringify(stats.map(s => ({
          id: s.id, 
          name: s.name, 
          ip: s.ip, 
          latency: s.latency, 
          avgJitter: s.avgJitter, 
          loss: s.packet_loss
      }))); %>
      allNodes = <%- nodesJson %>;
      filteredNodes = [...allNodes];
      
      // Initialize map for sorting/filtering
      allNodes.forEach(node => {
          nodeStats.set(String(node.id), {
              latency: node.latency || 0,
              jitter: node.avgJitter || 0,
              loss: node.loss || 0
          });
      });

      const searchInput = document.getElementById('nodeSearch');
      const nodeDropdown = document.getElementById('nodeDropdown');
      const mainMenuBtn = document.getElementById('mainMenuBtn');
      const mainDropdown = document.getElementById('mainDropdown');

      // --- Main Menu Handlers ---
      mainMenuBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        const isVisible = mainDropdown.style.display === 'block';
        document.querySelectorAll('.dropdown, .main-dropdown').forEach(el => el.style.display = 'none');
        mainDropdown.style.display = isVisible ? 'none' : 'block';
      });

      document.getElementById('openSettingsBtn').addEventListener('click', () => {
        openSettingsModal();
        mainDropdown.style.display = 'none';
      });

      // --- Backup / Restore ---
      document.getElementById('backupBtn').addEventListener('click', async () => {
        try {
          const response = await fetch('/api/backup');
          if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            a.download = `beanping-backup-${timestamp}.db`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
          } else { alert('Backup failed'); }
        } catch (error) { alert('Backup error: ' + error.message); }
        mainDropdown.style.display = 'none';
      });

      document.getElementById('restoreBtn').addEventListener('click', () => {
        document.getElementById('restoreFileInput').click();
        mainDropdown.style.display = 'none';
      });

      document.getElementById('restoreFileInput').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        if (!file.name.endsWith('.db')) { alert('Please select a valid .db file'); return; }
        if (!confirm('WARNING: This will replace your current database. Make sure you have a backup! Continue?')) { return; }

        const formData = new FormData();
        formData.append('backup', file);

        try {
          const response = await fetch('/api/restore', { method: 'POST', body: formData });
          const result = await response.json();
          if (response.ok) {
            alert('Database restored successfully! The application will restart shortly.');
            setTimeout(() => { window.location.reload(); }, 2000);
          } else { alert('Restore failed: ' + result.error); }
        } catch (error) { alert('Restore error: ' + error.message); }
        e.target.value = '';
      });

      document.getElementById('vtraceBtn').addEventListener('click', () => {
        window.location.href = '/vtraceroute';
        mainDropdown.style.display = 'none';
      });

      // --- Settings Modal Logic ---
      function openSettingsModal() {
        document.getElementById('settingsModal').classList.remove('hidden');
        document.getElementById('settingsModal').classList.add('flex');
        loadGlobalSettings();
        loadWebhooks();
      }

      function closeSettingsModal() {
        document.getElementById('settingsModal').classList.add('hidden');
        document.getElementById('settingsModal').classList.remove('flex');
      }

      function switchSettingsTab(tabName) {
        document.querySelectorAll('#settingsModal .tab-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        
        document.getElementById('settings-tab-general').classList.add('hidden');
        document.getElementById('settings-tab-webhooks').classList.add('hidden');
        document.getElementById(`settings-tab-${tabName}`).classList.remove('hidden');
      }

      async function loadGlobalSettings() {
        const res = await fetch('/api/settings');
        const data = await res.json();
        document.getElementById('setting_offline').value = data.offline_grace_period;
        document.getElementById('setting_online').value = data.online_grace_period;
        document.getElementById('setting_loss').value = data.packet_loss_threshold;
      }

      async function saveGlobalSettings() {
        const payload = {
          offline_grace_period: document.getElementById('setting_offline').value,
          online_grace_period: document.getElementById('setting_online').value,
          packet_loss_threshold: document.getElementById('setting_loss').value,
        };
        await fetch('/api/settings', { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
        alert('Settings saved!');
      }

      // --- Webhook Logic (Global) ---
      async function loadWebhooks() {
        const res = await fetch('/api/webhooks');
        const webhooks = await res.json();
        const container = document.getElementById('webhookList');
        container.innerHTML = '';
        
        if (webhooks.length === 0) {
          container.innerHTML = '<p class="text-sm text-slate-500 italic">No webhooks configured.</p>';
          return;
        }

        webhooks.forEach(wh => {
          const div = document.createElement('div');
          div.className = 'bg-slate-900/50 border border-slate-700 p-3 rounded-lg flex flex-col gap-2';
          div.innerHTML = `
            <div class="flex justify-between items-start">
              <div>
                <h4 class="font-medium text-slate-200">${wh.name}</h4>
                <p class="text-xs text-slate-500 truncate max-w-[250px]">${wh.url}</p>
              </div>
              <div class="flex gap-2">
                <button onclick="testWebhook(${wh.id})" class="text-xs bg-slate-700 hover:bg-slate-600 px-2 py-1 rounded transition">Test</button>
                <button onclick="deleteWebhook(${wh.id})" class="text-xs bg-red-900/50 hover:bg-red-900 text-red-200 px-2 py-1 rounded transition">Del</button>
              </div>
            </div>
            <div class="flex gap-3 text-xs text-slate-400">
               <span class="${wh.notify_online ? 'text-green-400' : 'text-slate-600'}">Online: ${wh.notify_online ? 'Yes' : 'No'}</span>
               <span class="${wh.notify_offline ? 'text-red-400' : 'text-slate-600'}">Offline: ${wh.notify_offline ? 'Yes' : 'No'}</span>
            </div>
          `;
          container.appendChild(div);
        });
      }

      function showAddWebhookForm() {
        document.getElementById('addWebhookForm').classList.remove('hidden');
      }

      async function addWebhook() {
        const name = document.getElementById('newWebhookName').value;
        const url = document.getElementById('newWebhookUrl').value;
        const online = document.getElementById('newWebhookOnline').checked;
        const offline = document.getElementById('newWebhookOffline').checked;
        
        if(!name || !url) return alert('Name and URL required');
        
        await fetch('/api/webhooks', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ name, url, notify_online: online, notify_offline: offline })
        });
        
        document.getElementById('newWebhookName').value = '';
        document.getElementById('newWebhookUrl').value = '';
        document.getElementById('addWebhookForm').classList.add('hidden');
        loadWebhooks();
      }

      async function deleteWebhook(id) {
        if(confirm('Delete this webhook?')) {
          await fetch(`/api/webhooks/${id}`, { method: 'DELETE' });
          loadWebhooks();
        }
      }

      async function testWebhook(id) {
        const res = await fetch(`/api/webhooks/${id}/test`, { method: 'POST' });
        const data = await res.json();
        if(data.success) alert('Test webhook sent!');
        else alert('Failed: ' + data.error);
      }

      // --- Node Stats & Sort Logic ---

      function getSortValue(card, field) {
        const nodeId = card.id.replace('node-', '');
        const stats = nodeStats.get(nodeId) || {};
        switch(field) {
            case 'name': return card.dataset.name;
            case 'ip': return card.dataset.ip.split('.').reduce((acc, octet) => (acc << 8) + parseInt(octet, 10), 0);
            case 'latency': return stats.latency || -1;
            case 'loss': return stats.loss !== undefined ? stats.loss : -1;
            case 'jitter': return stats.jitter || -1;
            default: return 0;
        }
      }

      function sortNodes(field, toggleDirection = true) {
        const container = document.getElementById('nodesContainer');
        const cards = Array.from(container.querySelectorAll('.node-card'));

        if (toggleDirection) {
            if (currentSort.field === field) {
                currentSort.direction = currentSort.direction === 1 ? 2 : 1;
            } else {
                currentSort.field = field;
                currentSort.direction = 1;
            }
        }

        document.querySelectorAll('.list-header-btn').forEach(btn => {
            btn.classList.remove('active');
            const icon = btn.querySelector('.sort-icon');
            icon.style.transform = 'rotate(0deg)';
        });

        const activeBtn = document.querySelector(`[data-sort="${field}"]`);
        if (activeBtn) {
            activeBtn.classList.add('active');
            const icon = activeBtn.querySelector('.sort-icon');
            if (currentSort.direction === 2) { icon.style.transform = 'rotate(180deg)'; }
        }

        cards.sort((a, b) => {
            const valueA = getSortValue(a, field);
            const valueB = getSortValue(b, field);
            let result = 0;
            if (typeof valueA === 'string') {
                result = valueA.localeCompare(valueB);
            } else {
                result = valueA - valueB;
            }
            return currentSort.direction === 1 ? result : -result;
        });
        cards.forEach(card => container.appendChild(card));
      }

      document.querySelectorAll('.list-header-btn[data-sort]').forEach(btn => {
        btn.addEventListener('click', () => sortNodes(btn.dataset.sort));
      });

      function filterNodes(query) {
        const q = query.toLowerCase().trim();
        filteredNodes = !q ? [...allNodes] : allNodes.filter(node => node.name.toLowerCase().includes(q) || node.ip.includes(q));
        renderDropdown();
      }

      function renderDropdown() {
        if (filteredNodes.length === 0) {
            nodeDropdown.innerHTML = '<div class="px-4 py-3 text-center text-slate-400">No nodes found</div>';
        } else {
            nodeDropdown.innerHTML = filteredNodes.map(node => `
                <div class="px-4 py-3 cursor-pointer hover:bg-white/10 transition" onclick="navigateToNode(${node.id})">
                    <div class="font-medium text-slate-100">${node.name}</div>
                    <div class="text-sm text-slate-400">${node.ip}</div>
                </div>
            `).join('');
        }
      }

      function navigateToNode(nodeId) { window.location.href = `/node/${nodeId}`; }
      
      function showDropdown() {
        renderDropdown();
        nodeDropdown.style.display = 'block';
      }

      searchInput.addEventListener('focus', showDropdown);
      searchInput.addEventListener('input', (e) => {
        filterNodes(e.target.value);
        showDropdown();
      });

      document.addEventListener('click', (e) => {
        const searchContainer = e.target.closest('.relative.max-w-2xl');
        const controlsContainer = e.target.closest('.controls-container');

        if (!searchContainer) {
            nodeDropdown.style.display = 'none';
        }
        if (!controlsContainer) {
            mainDropdown.style.display = 'none';
        }

        if (!e.target.closest(".menu-btn")) {
            document.querySelectorAll(".dropdown").forEach(el => el.style.display = "none");
            document.querySelectorAll(".node-card.z-20").forEach(c => c.classList.remove('z-20'));
        }
      });

      // --- Global Tools ---
      document.getElementById("globalMtrBtn").addEventListener("click", () => openGlobalTestModal("mtr"));
      document.getElementById("globalTraceBtn").addEventListener("click", () => openGlobalTestModal("traceroute"));

      function openGlobalTestModal(type) {
        currentGlobalTest = type;
        const modal = document.getElementById("globalTestModal");
        modal.innerHTML = `
        <div class="glass-morphism rounded-2xl shadow-2xl w-full max-w-md animate-fade-in">
            <header class="p-4 border-b border-white/10 flex justify-between items-center"><h2 class="text-xl font-semibold text-blue-300">Run ${type.toUpperCase()}</h2><button onclick="closeGlobalTestModal()" class="w-8 h-8 rounded-full hover:bg-white/10 flex items-center justify-center transition">&times;</button></header>
            <form id="globalTestForm" class="p-6 space-y-4">
              <div>
                  <label class="block text-slate-300 mb-2">Target IP/Hostname</label>
                  <input type="text" id="globalTestIp" required class="w-full p-2 rounded-lg bg-slate-900/50 border border-slate-600 focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
              </div>
              <div class="flex justify-end gap-2 pt-2">
                  <button type="button" onclick="closeGlobalTestModal()" class="btn glass-morphism hover:bg-white/10">Cancel</button>
                  <button type="submit" class="btn glass-morphism hover:bg-blue-500/30">Run</button>
              </div>
            </form>
        </div>`;
        modal.classList.remove("hidden");
        modal.classList.add("flex");
        document.getElementById("globalTestForm").addEventListener("submit", handleGlobalTestSubmit);
      }
      function closeGlobalTestModal() { document.getElementById("globalTestModal").classList.add("hidden"); }

      async function handleGlobalTestSubmit(e) {
        e.preventDefault();
        const ip = document.getElementById("globalTestIp").value.trim();
        if (!ip) return;
        const runBtn = e.target.querySelector("button[type='submit']");
        runBtn.disabled = true; runBtn.innerHTML = `Running...`;
        try {
            const res = await fetch(`/api/${currentGlobalTest}`, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ ip }) });
            const data = await res.json();
            if (data.output) { showResultModal(`${currentGlobalTest.toUpperCase()} Results`, data.output); }
            else { alert(`${currentGlobalTest.toUpperCase()} failed: ` + (data.error || "Unknown error")); }
        } catch (err) { alert(`${currentGlobalTest.toUpperCase()} request failed: ` + err.message); }
        runBtn.disabled = false; runBtn.textContent = "Run";
        closeGlobalTestModal();
      }

      function showResultModal(title, output) {
        const modal = document.createElement("div");
        modal.className = "fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-fade-in";
        modal.innerHTML = `
        <div class="glass-morphism rounded-2xl shadow-2xl w-full max-w-4xl max-h-[85vh] flex flex-col">
          <header class="p-4 border-b border-white/10 flex justify-between items-center">
            <h2 class="text-xl font-semibold bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">${title}</h2>
            <button onclick="this.closest('.fixed').remove()" class="w-8 h-8 rounded-full hover:bg-white/10 flex items-center justify-center transition">&times;</button>
          </header>
          <div class="p-6 bg-slate-900/50 flex-grow overflow-auto"><pre class="whitespace-pre-wrap text-sm text-slate-300 break-words">${output}</pre></div>
        </div>`;
        modal.addEventListener("click", (e) => { if (e.target === modal) modal.remove(); });
        document.body.appendChild(modal);
      }

      function sanitizeIp(ip) { return ip.trim().replace(/[^0-9a-fA-F\.:]/g, ""); }

      document.getElementById("toggleAddNode").addEventListener("click", () => {
        document.getElementById("addNodeForm").classList.toggle("hidden");
      });

      document.getElementById("addNodeForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const name = document.getElementById("name").value.trim();
        let ip = sanitizeIp(document.getElementById("ip").value);
        if (!name || !ip) { alert("Please enter a valid name and IP address"); return; }
        await fetch("/api/nodes", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ name, ip }) });
        e.target.reset();
        document.getElementById("addNodeForm").classList.add("hidden");
      });

      // --- Node Edit Logic ---

      async function editNode(id, name, ip) {
        // Fetch extended data
        const [graceRes, webhookRes] = await Promise.all([
           fetch(`/api/nodes/${id}/grace-periods`),
           fetch(`/api/nodes/${id}/webhooks`)
        ]);
        const graceData = await graceRes.json();
        const webhooksData = await webhookRes.json();
        
        // Prepare Override checkbox state
        const isOverride = graceData.node.offline_grace_period !== null || graceData.node.online_grace_period !== null;
        
        // Prepare Webhook List HTML
        let webhookHtml = '';
        if (webhooksData.length === 0) {
           webhookHtml = '<p class="text-sm text-slate-500">No webhooks defined globally. Add some in Global Settings first.</p>';
        } else {
           webhookHtml = webhooksData.map(wh => {
             const isEnabled = wh.has_override ? wh.override_enabled : wh.enabled;
             return `
             <div class="flex items-center justify-between bg-slate-900/30 p-2 rounded mb-2 border border-slate-700/50">
                <div class="text-sm text-slate-300">${wh.name}</div>
                <div class="flex items-center gap-2">
                   <label class="text-xs text-slate-500 mr-2">Notify:</label>
                   <input type="checkbox" class="webhook-toggle" data-id="${wh.id}" ${isEnabled ? 'checked' : ''}>
                </div>
             </div>
             `;
           }).join('');
        }

        const modal = document.getElementById("editModal");
        modal.innerHTML = `
        <div class="glass-morphism rounded-2xl shadow-2xl w-full max-w-lg max-h-[90vh] flex flex-col animate-fade-in">
          <header class="p-4 border-b border-white/10 flex justify-between items-center"><h2 class="text-xl font-semibold text-blue-300">Edit Node</h2><button onclick="closeEditModal()" class="w-8 h-8 rounded-full hover:bg-white/10 flex items-center justify-center transition">&times;</button></header>
          
          <div class="flex border-b border-white/10 px-4">
             <button class="tab-btn active" onclick="switchEditTab('basic')">General</button>
             <button class="tab-btn" onclick="switchEditTab('alerts')">Alerts</button>
             <button class="tab-btn" onclick="switchEditTab('webhooks')">Webhooks</button>
          </div>

          <form id="editNodeForm" class="p-6 flex-grow overflow-y-auto">
            <input type="hidden" id="editId" value="${id}">
            
            <!-- Tab: Basic -->
            <div id="edit-tab-basic" class="space-y-4">
               <div>
                 <label class="block text-slate-300 mb-2">Name</label>
                 <input type="text" id="editName" value="${name}" required class="w-full p-2 rounded-lg bg-slate-900/50 border border-slate-600 focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
               </div>
               <div>
                 <label class="block text-slate-300 mb-2">IP Address</label>
                 <input type="text" id="editIp" value="${ip}" required class="w-full p-2 rounded-lg bg-slate-900/50 border border-slate-600 focus:ring-2 focus:ring-blue-500 focus:outline-none transition">
               </div>
            </div>

            <!-- Tab: Alerts -->
            <div id="edit-tab-alerts" class="space-y-4 hidden">
               <div class="flex items-center gap-2 mb-4">
                  <input type="checkbox" id="overrideGrace" ${isOverride ? 'checked' : ''} onchange="toggleGraceInputs(this.checked)">
                  <label for="overrideGrace" class="text-slate-300 text-sm">Override Global Grace Periods</label>
               </div>
               <div id="graceInputs" class="${isOverride ? '' : 'opacity-50 pointer-events-none'} space-y-4 transition-opacity">
                  <div>
                    <label class="block text-slate-300 mb-1 text-sm">Offline Grace (pings)</label>
                    <input type="number" id="editOffline" value="${graceData.effective.offline}" class="w-full p-2 rounded-lg bg-slate-900/50 border border-slate-600">
                  </div>
                  <div>
                    <label class="block text-slate-300 mb-1 text-sm">Online Grace (pings)</label>
                    <input type="number" id="editOnline" value="${graceData.effective.online}" class="w-full p-2 rounded-lg bg-slate-900/50 border border-slate-600">
                  </div>
               </div>
            </div>

            <!-- Tab: Webhooks -->
            <div id="edit-tab-webhooks" class="space-y-4 hidden">
               <p class="text-xs text-slate-400 mb-2">Toggle specific webhooks for this node.</p>
               ${webhookHtml}
            </div>

            <div class="flex justify-end gap-2 pt-6 border-t border-white/10 mt-4">
              <button type="button" onclick="closeEditModal()" class="btn glass-morphism hover:bg-white/10">Cancel</button>
              <button type="submit" class="btn glass-morphism hover:bg-blue-500/30">Save Changes</button>
            </div>
          </form>
        </div>`;
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        document.getElementById("editNodeForm").addEventListener("submit", handleEditNodeSubmit);
      }
      
      window.switchEditTab = function(tab) {
         document.querySelectorAll('#editModal .tab-btn').forEach(btn => btn.classList.remove('active'));
         event.target.classList.add('active');
         ['basic', 'alerts', 'webhooks'].forEach(t => {
            const el = document.getElementById(`edit-tab-${t}`);
            if(t === tab) el.classList.remove('hidden');
            else el.classList.add('hidden');
         });
      };

      window.toggleGraceInputs = function(enabled) {
         const div = document.getElementById('graceInputs');
         if(enabled) {
            div.classList.remove('opacity-50', 'pointer-events-none');
         } else {
            div.classList.add('opacity-50', 'pointer-events-none');
         }
      };

      function closeEditModal() { document.getElementById("editModal").classList.add("hidden"); }

      async function handleEditNodeSubmit(e) {
        e.preventDefault();
        const id = document.getElementById("editId").value;
        const name = document.getElementById("editName").value.trim();
        let ip = sanitizeIp(document.getElementById("editIp").value);
        
        // 1. Save Basic Info
        await fetch(`/api/nodes/${id}`, { method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ name, ip }) });
        
        // 2. Save Grace Periods
        const override = document.getElementById('overrideGrace').checked;
        const gracePayload = {
           offline_grace_period: override ? document.getElementById('editOffline').value : null,
           online_grace_period: override ? document.getElementById('editOnline').value : null,
        };
        await fetch(`/api/nodes/${id}/grace-periods`, { method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify(gracePayload) });

        // 3. Save Webhook Toggles
        const toggles = document.querySelectorAll('.webhook-toggle');
        for (const toggle of toggles) {
           const webhookId = toggle.dataset.id;
           const enabled = toggle.checked;
           await fetch(`/api/nodes/${id}/webhooks/${webhookId}`, {
              method: 'POST',
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ enabled: enabled, notify_online: true, notify_offline: true })
           });
        }

        closeEditModal();
        alert("Node updated successfully");
      }

      async function deleteNode(id) {
        if (confirm("Are you sure you want to delete this node?")) {
          await fetch(`/api/nodes/${id}`, { method: "DELETE" });
        }
      }

      // --- View & Menu Toggles ---

      function toggleMenu(view, id) {
        const menuId = `menu-${view}-${id}`;
        const menu = document.getElementById(menuId);
        const card = menu.closest('.node-card');
        const isOpening = menu.style.display !== "block";

        document.querySelectorAll(".dropdown").forEach(el => el.style.display = "none");
        document.querySelectorAll(".node-card").forEach(c => c.classList.remove('z-20'));

        if (isOpening) {
            menu.style.display = "block";
            if (card) card.classList.add('z-20');
        }
      }

      function applyView(mode) {
        localStorage.setItem("viewMode", mode);
        const container = document.getElementById("nodesContainer");
        const gridBtn = document.getElementById("gridBtn");
        const listBtn = document.getElementById("listBtn");
        const listHeader = document.getElementById("listHeader");
        document.querySelectorAll(".node-card").forEach(card => {
            card.querySelector(".grid-view").classList.toggle("hidden", mode === "list");
            card.querySelector(".list-view").classList.toggle("hidden", mode === "grid");
        });
        if (mode === "grid") {
            container.className = "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6";
            listHeader.classList.add("hidden");
            gridBtn.classList.add("active-view");
            listBtn.classList.remove("active-view");
        } else {
            container.className = "flex flex-col gap-3";
            listHeader.classList.remove("hidden");
            listBtn.classList.add("active-view");
            gridBtn.classList.remove("active-view");
        }
      }
      gridBtn.addEventListener("click", () => applyView("grid"));
      listBtn.addEventListener("click", () => applyView("list"));
      
      document.addEventListener('DOMContentLoaded', () => {
          applyView(localStorage.getItem("viewMode") || "grid");
          sortNodes(currentSort.field, false);
      });

      // --- Socket Events (Optimized) ---

      socket.on("pingUpdate", (data) => {
        const card = document.querySelector(`#node-${data.nodeId}`);
        if (card) {
            const nodeIdStr = String(data.nodeId);
            // Receive calculated stats directly from backend
            const loss = data.packetLoss1h.toFixed(1);

            card.querySelectorAll(".latency").forEach(el => el.textContent = data.latency || "N/A");
            card.querySelectorAll(".jitter").forEach(el => el.textContent = (data.jitter || 0).toFixed(2));
            card.querySelectorAll(".loss").forEach(el => el.textContent = loss);
            card.querySelectorAll(".status-dot").forEach(el => el.className = "status-dot " + data.status);
            
            // Update internal map for sorting
            nodeStats.set(nodeIdStr, { 
                latency: data.latency || 0, 
                jitter: data.jitter || 0, 
                loss: data.packetLoss1h 
            });
        }
      });

      socket.on("problemNodesUpdate", (problemNodes) => {
        const list = document.getElementById("problemNodesList");
        list.innerHTML = "";
        if (problemNodes.length === 0) {
          list.innerHTML = `<li class="text-green-400 flex items-center gap-2 text-sm">
            <svg class="w-5 h-5" fill="currentColor"><use href="icons.svg#icon-check-circle"></use></svg>
            No problem nodes detected in the last hour.
          </li>`;
        } else {
          problemNodes.forEach(p => {
            const li = document.createElement("li");
            li.className = "flex flex-wrap justify-between items-center bg-slate-900/50 p-3 rounded-lg text-sm";
            li.innerHTML = `
              <div>
                <a href="/node/${p.id}" class="font-semibold node-link">${p.name}</a>
                <span class="text-slate-400 ml-2">(${p.ip})</span>
              </div>
              <div class="text-slate-300 text-right">
                ${p.loss10Count >= 4 ? `<span class="text-orange-400">Packet Loss (10% - ${p.loss10Count} times)</span>` : ""}
                ${p.highLossCount >= 4 ? `<span class="text-red-400 ml-2">High Packet Loss (>10% - ${p.highLossCount} times)</span>` : ""}
                ${p.highJitterCount >= 4 ? `<span class="ml-2 text-yellow-400">High Jitter (${p.highJitterCount} times)</span>` : ""}
              </div>
            `;
            list.appendChild(li);
          });
        }
      });

      socket.on("nodeAdded", (node) => {
        // Simple reload to ensure clean state and proper map initialization
        window.location.reload();
      });

      socket.on("nodeUpdated", (node) => {
        const nodeIndex = allNodes.findIndex(n => n.id == node.id);
        if (nodeIndex !== -1) { allNodes[nodeIndex] = {id: node.id, name: node.name, ip: node.ip}; }
        const card = document.querySelector(`#node-${node.id}`);
        if (card) {
          card.setAttribute('data-name', node.name.toLowerCase());
          card.setAttribute('data-ip', node.ip);
          card.querySelectorAll(".node-name").forEach(el => el.textContent = node.name);
          card.querySelectorAll(".node-ip").forEach(el => el.textContent = node.ip);
        }
      });

      socket.on("nodeRemoved", (node) => {
        allNodes = allNodes.filter(n => n.id != node.id);
        nodeStats.delete(String(node.id));
        const card = document.querySelector(`#node-${node.id}`);
        if (card) card.remove();
      });
    </script>
  </body>
</html>
